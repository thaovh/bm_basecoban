-- ALTER TABLE script for BMM_RESULT_TRACKINGS
-- This script updates the existing table with new fields and renames ROOM_ID to REQUEST_ROOM_ID

-- Step 1: Add new columns
ALTER TABLE BMM_RESULT_TRACKINGS ADD (
    IN_ROOM_ID VARCHAR2(36),
    SAMPLE_TYPE_ID VARCHAR2(36),
    SAMPLE_CODE VARCHAR2(50)
);

-- Step 2: Rename ROOM_ID to REQUEST_ROOM_ID
-- Note: Oracle doesn't support direct column rename, so we need to:
-- 1. Add new column REQUEST_ROOM_ID
-- 2. Copy data from ROOM_ID to REQUEST_ROOM_ID
-- 3. Drop old column ROOM_ID

-- Add new REQUEST_ROOM_ID column
ALTER TABLE BMM_RESULT_TRACKINGS ADD REQUEST_ROOM_ID VARCHAR2(36);

-- Copy data from ROOM_ID to REQUEST_ROOM_ID
UPDATE BMM_RESULT_TRACKINGS SET REQUEST_ROOM_ID = ROOM_ID WHERE ROOM_ID IS NOT NULL;

-- Drop the old ROOM_ID column
ALTER TABLE BMM_RESULT_TRACKINGS DROP COLUMN ROOM_ID;

-- Step 3: Add foreign key constraints for new columns
ALTER TABLE BMM_RESULT_TRACKINGS ADD CONSTRAINT FK_BMM_RT_IN_ROOM 
    FOREIGN KEY (IN_ROOM_ID) REFERENCES BMM_ROOMS(ID);

ALTER TABLE BMM_RESULT_TRACKINGS ADD CONSTRAINT FK_BMM_RT_SAMPLE_TYPE 
    FOREIGN KEY (SAMPLE_TYPE_ID) REFERENCES BMM_SAMPLE_TYPES(ID);

-- Step 4: Add indexes for new columns
CREATE INDEX IDX_BMM_RT_IN_ROOM_ID ON BMM_RESULT_TRACKINGS(IN_ROOM_ID);
CREATE INDEX IDX_BMM_RT_SAMPLE_TYPE_ID ON BMM_RESULT_TRACKINGS(SAMPLE_TYPE_ID);
CREATE INDEX IDX_BMM_RT_SAMPLE_CODE ON BMM_RESULT_TRACKINGS(SAMPLE_CODE);

-- Step 5: Update existing foreign key constraint name (if needed)
-- Drop old constraint if it exists
ALTER TABLE BMM_RESULT_TRACKINGS DROP CONSTRAINT FK_BMM_RT_ROOM;

-- Add new constraint for REQUEST_ROOM_ID
ALTER TABLE BMM_RESULT_TRACKINGS ADD CONSTRAINT FK_BMM_RT_REQUEST_ROOM 
    FOREIGN KEY (REQUEST_ROOM_ID) REFERENCES BMM_ROOMS(ID);

-- Step 6: Update existing index name (if needed)
-- Drop old index if it exists
DROP INDEX IDX_BMM_RT_ROOM_ID;

-- Add new index for REQUEST_ROOM_ID
CREATE INDEX IDX_BMM_RT_REQUEST_ROOM_ID ON BMM_RESULT_TRACKINGS(REQUEST_ROOM_ID);

-- Step 7: Add comments for clarity
COMMENT ON COLUMN BMM_RESULT_TRACKINGS.REQUEST_ROOM_ID IS 'Phong yeu cau xet nghiem';
COMMENT ON COLUMN BMM_RESULT_TRACKINGS.IN_ROOM_ID IS 'Phong dang xu ly mau';
COMMENT ON COLUMN BMM_RESULT_TRACKINGS.SAMPLE_TYPE_ID IS 'Loai mau (mau, nuoc tieu, etc.)';
COMMENT ON COLUMN BMM_RESULT_TRACKINGS.SAMPLE_CODE IS 'Ma mau duy nhat';

-- Step 8: Verify the changes
SELECT 
    COLUMN_NAME,
    DATA_TYPE,
    DATA_LENGTH,
    NULLABLE
FROM USER_TAB_COLUMNS 
WHERE TABLE_NAME = 'BMM_RESULT_TRACKINGS'
ORDER BY COLUMN_NAME;

-- Step 9: Check constraints
SELECT 
    CONSTRAINT_NAME,
    CONSTRAINT_TYPE,
    TABLE_NAME
FROM USER_CONSTRAINTS 
WHERE TABLE_NAME = 'BMM_RESULT_TRACKINGS';

-- Step 10: Check indexes
SELECT 
    INDEX_NAME,
    COLUMN_NAME
FROM USER_IND_COLUMNS 
WHERE TABLE_NAME = 'BMM_RESULT_TRACKINGS'
ORDER BY INDEX_NAME, COLUMN_POSITION;
